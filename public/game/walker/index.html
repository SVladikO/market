<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Walker</title>
    <style>

        * {
            font-family: Arial;
            padding: 0;
            margin: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            overflow: hidden;
        }

        canvas {
            cursor: cell;
        }

        .guns > img {
            height: 80px;
            border: solid 1px black;
            margin: 10px;
        }

        .wrapper {
            display: flex;

        }

        #notification {
            display: none;
            position: absolute;
            top: 0;
            border: solid 1px red;
            width: 1000px;
            height: 600px;
            background: #ff0000e3;
            justify-content: center;
            align-items: center;
        }

        #alert_notification {
            color: red;
            height: 40px;
            text-align: center;
            width: 1000px;
            padding: 10px 0;
            margin: 0px;
            position: absolute;
            top: 0;
        }

        .themes {
            padding: 10px;
        }

        .themes > button {
            font-size: 30px;
            padding: 4px 8px;
            margin: 4px;
        }

        #user_walk_btn,
        #user_direction_btn {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: solid 2px red;
            position: absolute;
        }

        #user_walk_btn {
            display: flex;
            justify-content: center;
            align-items: center;
            bottom: 40px;
            left: 40px;
        }

        #reload_gun_btn,
        #shoot_gun_btn {
            border-radius: 50%;
            border: solid 2px red;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            right: 200px;
        }
        #reload_gun_btn {
            bottom: 150px;
        }
        #shoot_gun_btn {
            bottom: 50px;
        }

        #health {
            position: absolute;
            top: 0;
            right: 0;
        }

        .gun_images > img {
            display: none;
        }

        #user_direction_btn {
            bottom: 40px;
            right: 40px;
        }

        .move_button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: red;
            display: block;
        }

        .move_button_not_active {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: block;
            margin: auto;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div class="board">
        <canvas id="canvas" width="1000" height="600" style="border:1px solid #000000;"></canvas>

        <div id="user_walk_btn">
            <div class="move_button move-left-btn">a</div>
            <div>
                <div class="move_button">w</div>
                <div class="move_button_not_active"></div>
                <div class="move_button">s</div>
            </div>
            <div class="move_button">d</div>
        </div>
        <div id="user_direction_btn"></div>
        <div id="reload_gun_btn">reload</div>
        <div id="shoot_gun_btn">shoot</div>


        <h1 id="notification"></h1>
        <h1 id="alert_notification"></h1>
    </div>
    <h1 id="health" class="themes"></h1>

    <!--    <div class="control_panel">-->
    <!--        <div class="guns themes">-->
    <!--            <h1>Available guns:</h1>-->
    <!--            <img onclick="updateWeapon('weapon_gun1')" src="./public/img/gun1.jpeg" alt="">-->
    <!--            <img onclick="updateWeapon('weapon_gun2')" src="./public/img/gun2.png" alt="">-->
    <!--            <img onclick="updateWeapon('weapon_gun3')" src="./public/img/gun3.jpeg" alt="">-->
    <!--        </div>-->
    <!--        <div class="themes">-->
    <!--            <h1>Themes:</h1>-->
    <!--            <button onclick="changeStyleToWinter()">winter</button>-->
    <!--            <button onclick="changeStyleToSummer()">summer</button>-->
    <!--            <button onclick="changeStyleToSpring()">spring</button>-->
    <!--        </div>-->

    <!--        <div class="themes">-->
    <!--            <h1>Sound control:</h1>-->
    <!--            <button onclick="mute()">Mute</button>-->
    <!--            <button onclick="unmute()">Unmute</button>-->
    <!--        </div>-->
    <!--        <div class="themes">-->
    <!--            <h1>Levels:</h1>-->
    <!--            <button onclick="changeLevel(0)">1</button>-->
    <!--            <button onclick="changeLevel(1)">2</button>-->
    <!--            <button onclick="changeLevel(2)">3</button>-->
    <!--            <button onclick="changeLevel(3)">4</button>-->
    <!--            <button onclick="changeLevel(4)">5</button>-->
    <!--            <button onclick="changeLevel(5)">6</button>-->
    <!--            <button onclick="changeLevel(6)">7</button>-->
    <!--            <button onclick="changeLevel(7)">8</button>-->
    <!--            <button onclick="changeLevel(8)">9</button>-->
    <!--            <button onclick="changeLevel(9)">10</button>-->
    <!--        </div>-->
    <!--    </div>-->
</div>
<div class="gun_images">
    <img id="gunIconId1" src="./public/img/pistol2.webp" alt="gun1" width="220" height="277">
    <img id="gunIconId2" src="./public/img/ak1.webp" alt="gun2" width="220" height="277">
    <img id="gunIconId3" src="./public/img/gun1.webp" alt="gun3" width="220" height="277">
</div>


<!--SCRIPTS-->

<script src="./script/calculation.js"></script>
<script src="./script/entity.js"></script>
<script src="./script/global_var.js"></script>
<script src="./script/render.js"></script>
<script src="./script/style.js"></script>

<script>
    const ctx = canvas.getContext("2d");
    ctx.canvas.width = window.innerWidth;
    ctx.canvas.height = window.innerHeight;

    let isMute = false;

    function mute() {
        isMute = true;
    }

    function unmute() {
        isMute = false;
    }

    function reloadUserGun(e) {
        user.reloadGun();
    }

    function updateWeapon(n) {
        const weapons = {
            weapon_gun1,
            weapon_gun2,
            weapon_gun3,
        }

        user.weapon = weapons[n]
    }

    function drawAll() {
        clearCanvas();
        prepareCanvas();
        renderRectangles()

        health.textContent = 'Health: ' + user.health + ' / Bullets amount: ' + user.bulletAmount

        flyBullets.forEach(bullet => bullet.move());
        flyBullets.forEach(bullet => bullet.render());
        flyBullets = flyBullets.filter(bullet => !bullet.isDead);

        user.render();
        units
            // .filter(unit => user.isVisibleForMe(unit.x, unit.y))
            .forEach(unit => {
                unit.updateAngle(user.x, user.y)
                unit.render()
            })

        units = units.filter(unit => unit.isAlive())

        if (!user.isAlive()) {
            notification.textContent = 'GAME OVER';
            notification.style.display = 'flex';
        }

        renderEnd(finishCoordinates)
        renderMoveDirectionCenter()
    }

    const moveTabletDirectionCenter = {
        x: 120,
        y: 120,
    }

    function renderMoveDirectionCenter() {
        const width = ctx.canvas.width;
        const height = ctx.canvas.height;
        const x = width - moveTabletDirectionCenter.x;
        const y = height - moveTabletDirectionCenter.y;

        ctx.moveTo(x, y);
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, 300);
        ctx.fillStyle = "red";
        ctx.fill();
    }

    function renderEnd(c) {
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillText('FINISH', c.x, c.y);
    }

    window.addEventListener("click", () => user.shoot());

    


    window.addEventListener("keypress", (event) => {
        user.enableMove(event.key)
        event.key === ' ' && user.reloadGun()

        drawAll();
    });
    window.addEventListener("keyup", (event) => user.disableMove(event.key));
    window.addEventListener("mousemove", e => user.updateAngle(e.clientX, e.clientY));
   

    

    function loop() {
        user.move();
        drawAll();
        window.requestAnimationFrame(loop);
    }

    loop();


    setInterval(() => {
        const intervalId = setInterval(() => {
            units.forEach(unit => {
                // unit.reloadGun();
                if (unit.isVisibleForMe(user.x, user.y)) {
                    unit.shoot()
                } else {
                    console.log('invisible')
                }
            })

        }, 200)

        setTimeout(() => {
            clearInterval(intervalId)
        }, 1000)
    }, 2000)

    //MOBILE NAVIGATION BUTTONS
    function enableMobileNavigation() {
        
        user_walk_btn.addEventListener('mousedown', e => user.enableMove(e.target.innerText));
        user_walk_btn.addEventListener('mouseup', e => user.disableMove(e.target.innerText));

        user_walk_btn.addEventListener("touchstart", e => user.enableMove(e.target.innerText));
        user_walk_btn.addEventListener("touchend", e => user.disableMove(e.target.innerText));
        
        reload_gun_btn.addEventListener("click", e => {
            e.stopPropagation();
            user.reloadGun()
        });
        shoot_gun_btn.addEventListener("click", e => {
            e.stopPropagation();
            user.shoot()
        });
        
        user_direction_btn.addEventListener('click', function (e) {
            e.stopPropagation()
            user.updateAngleForMobile(e.clientX, e.clientY);
            user.shoot();
        });

        user_direction_btn.addEventListener('touchmove', function (e) {
            e.stopPropagation()
            user.updateAngleForMobile(e.clientX, e.clientY);
            user.shoot();
        });

    }
</script>
</body>
</html>