<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Walker</title>
</head>
<body>
<canvas id="canvas" width="1000" height="600" style="border:1px solid #000000;">
</canvas>
<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const canvasBgColor = "#ffc34d";

    const userBgColor = "black";
    const userBorderLineWidth = 1;
    const bulletBgColor = '#b30000';
    const bulletDeadBgColor = '#ffff00';

    const boxBgColor = "#663300";
    const boxBorderColor = "#4d2600";
    const boxBorderLineWidth = 5;

    let ganster1X = 900;
    let ganster1Y = 10;
    let ganster1Angle = 0

    let ganster2X = 900;
    let ganster2Y = 550;
    let ganster2Angle = 0

    const userDotRadius = 10;
    let userX = 180;
    let userY = 180;
    let visibilityRadius = 100;
    let userMoveStep = 0.5;
    let userAngle = 0

    let mousePositionX = 200;
    let mousePositionY = 200;

    //Object on the canvas
    // const rectangles = [[200, 200]];
    const rectangles = [[10, 10], [200, 200], [300, 80], [300, 400], [700, 500], [500, 10], [700, 50]];
    const rectangleSideLenght = 40;

    const weapon = {
        bulletAmount: 30,
        maxDistance: 200,
        bulletRadius: 5,
        bulletDeadRadius: 15,
        bulletBgColor,
        bulletDeadBgColor,
        distanceStep: 2,
        cartrigesMove: [],
        cartridgeÐ¡lip: 10,
        rechargeTime: 2,
    }

    function getCartridge(fromX, fromY, angle) {
        return {
            currentDistance: 0,
            startX: fromX,
            startY: fromY,
            lastX: fromX,
            lastY: fromY,
            angle: angle,
            isDead: false,
            isKickedBox: false,
        }
    }

    function shoot(key) {
        if (key != ' ') {
            return;
        }

        if (!weapon.bulletAmount) {
            alert('no bullets')
            return;
        }

        weapon.bulletAmount -= 1;
        new Audio('./public/gun-shot-fast.mp3').play()
        const bullet = getCartridge(userX, userY, userAngle);
        weapon.cartrigesMove.push(bullet)
    }

    function updateBulletData(bullet) {
        const {lastX, lastY, angle} = bullet;
        bullet.lastX = lastX + Math.cos(angle) * weapon.distanceStep;
        bullet.lastY = lastY + Math.sin(angle) * weapon.distanceStep;
        bullet.isKickedBox = isOnBlock(lastX, lastY);
        bullet.isDead = isOutOfRange(lastX, 0, canvas.width) || isOutOfRange(lastY, 0, canvas.height) || isOnBlock(lastX, lastY)
    }

    function renderBullet(bullet) {
        const {lastX, lastY} = bullet;

        ctx.beginPath();
        ctx.arc(lastX, lastY, bullet.isDead ? weapon.bulletDeadRadius : weapon.bulletRadius, 0, 2 * Math.PI);
        ctx.fillStyle = bullet.isDead ? weapon.bulletDeadBgColor : weapon.bulletBgColor;

        if (bullet.isKickedBox) {
            // new Audio('./public/missed-1.mp3').play()
        }

        ctx.fill()
    }

    function clearCanvas() {
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function prepareCanvas() {
        ctx.fillStyle = canvasBgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height)
    }

    function renderLine() {
        ctx.beginPath();
        ctx.moveTo(userX, userY);
        ctx.lineTo(mousePositionX, mousePositionY);
        ctx.stroke();
    }

    function renderRectangles() {
        rectangles.forEach(coordinates => {
            const [x, y] = coordinates;
            renderRectangle(x, y);
        })
    }

    function renderRectangle(x, y) {
        ctx.rect(x, y, rectangleSideLenght, rectangleSideLenght);
        ctx.fillStyle = boxBgColor;
        ctx.fill()
        ctx.strokeStyle = boxBorderColor;
        ctx.lineWidth = boxBorderLineWidth;
        ctx.stroke();
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
    }

    setInterval(() => {
        const bullet = getCartridge(ganster1X, ganster1Y, ganster1Angle);
        weapon.cartrigesMove.push(bullet)
    }, 1000)


    setInterval(() => {
        const bullet = getCartridge(ganster2X, ganster2Y, ganster2Angle);
        weapon.cartrigesMove.push(bullet)
    }, 1500)

    function getRadianAngle(fromX, toX, fromY, toY) {
        var dx = toX - fromX;
        var dy = toY - fromY;

        return Math.atan2(dy, dx);
    }

    function renderUser(x, y) {
        ctx.beginPath();
        ctx.arc(x, y, userDotRadius, 0, 300);
        ctx.fillStyle = userBgColor;
        ctx.fill()
    }

    function renderUserDirection(x, y, angle) {
        const step = 1;

        ctx.moveTo(x, y);
        ctx.arc(x, y, visibilityRadius, angle - step, angle + step, false);
        ctx.lineTo(x, y);
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    function drawAll() {
        clearCanvas();
        prepareCanvas();
        renderRectangles()

        weapon.cartrigesMove.forEach(updateBulletData);
        weapon.cartrigesMove.forEach(renderBullet);
        weapon.cartrigesMove = weapon.cartrigesMove.filter(bullet => !bullet.isDead);

        userAngle = getRadianAngle(userX, mousePositionX, userY, mousePositionY)
        ganster1Angle = getRadianAngle(ganster1X, userX, ganster1Y, userY)
        ganster2Angle = getRadianAngle(ganster2X, userX, ganster2Y, userY)

        renderUser(userX, userY);
        renderUserDirection(userX, userY, userAngle);

        renderUser(ganster1X, ganster1Y);
        renderUserDirection(ganster1X, ganster1Y, ganster1Angle);

        renderUser(ganster2X, ganster2Y);
        renderUserDirection(ganster2X, ganster2Y, ganster2Angle);

        renderLine();
    }

    const pressedKey = {
        'w': false, //up
        's': false, //down
        'a': false, //left
        'd': false, //right
    }

    window.addEventListener("click", (event) => {
        shoot(' ')
    });
    window.addEventListener("keypress", (event) => {
        // switch (event.keyCode) {
        //     case 87: //move up
        //         userY -= userMoveStep;
        //         break;
        //     case 83: //move down
        //         userY += userMoveStep;
        //         break;
        //     case 65: //move left
        //         userX -= userMoveStep;
        //         break;
        //     case 68: //move right
        //         userX += userMoveStep;
        // }
        enableMove(event.key)
        shoot(event.key)

        drawAll();
    });

    window.addEventListener("keyup", (event) => {
        disableMove(event.key);
    });

    window.addEventListener("mousemove", (event) => {
        mousePositionX = event.clientX
        mousePositionY = event.clientY
    });

    function loop() {
        changeUserCoordinates()
        drawAll();
        window.requestAnimationFrame(loop);
    }

    loop();

    /**
     * Enable user move.
     *
     * @param key - Pressed keyboard key.
     */
    function enableMove(key) {
        pressedKey[key.toLowerCase()] = true;
    }

    /**
     * Disable user move.
     *
     * @param key - Pressed keyboard key.
     */
    function disableMove(key) {
        pressedKey[key.toLowerCase()] = false;
    }

    function isInCanvas(modifiedPosition, max) {
        return !isOutOfRange(modifiedPosition, 0 + userDotRadius, max - userDotRadius)
    }

    function isOutOfRange(num, min, max) {
        return num <= min || num >= max;
    }

    function isInRange(num, min, max) {
        return num >= min && num <= max;
    }

    /**
     * Check is new user coordinates move on block
     *
     * @param userX
     * @param userY
     * @returns {boolean}
     */
    function isOnBlock(userX, userY) {
        const rect = rectangles.find(rec => {
            const [x, y] = rec;
            const minX = x - userDotRadius;
            const minY = y - userDotRadius;
            const maxX = minX + rectangleSideLenght + userDotRadius + userDotRadius;
            const maxY = minY + rectangleSideLenght + userDotRadius + userDotRadius;

            const is = isInRange(userX, minX, maxX) && isInRange(userY, minY, maxY)
            // console.log(1234, is, `x ${minX} < ${userX} < ${maxX} ::: y ${minY} < ${userY} < ${maxY}`)

            return is;
        })

        return !!rect;
    }

    function changeUserCoordinates() {
        if (pressedKey.w) {
            const modifiedUserY = userY - userMoveStep;

            if (isInCanvas(modifiedUserY, canvas.height) && !isOnBlock(userX, modifiedUserY)) {
                userY = modifiedUserY;
            }
        }
        if (pressedKey.s) {
            const modifiedUserY = userY + userMoveStep;

            if (isInCanvas(modifiedUserY, canvas.height) && !isOnBlock(userX, modifiedUserY)) {
                userY = modifiedUserY;
            }
        }
        if (pressedKey.a) {
            const modifiedUserX = userX - userMoveStep;

            if (isInCanvas(modifiedUserX, canvas.width) && !isOnBlock(modifiedUserX, userY)) {
                userX = modifiedUserX;
            }
        }
        if (pressedKey.d) {
            const modifiedUserX = userX + userMoveStep;

            if (isInCanvas(modifiedUserX, canvas.width) && !isOnBlock(modifiedUserX, userY)) {
                userX = modifiedUserX;
            }
        }
    }

</script>
</body>
</html>